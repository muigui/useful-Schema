function afterdefine(a){var b=a.__super__,c=a.prototype,d=c.mappings,e=c.properties;return delete c.mappings,delete c.properties,"object"==typeof b.__mappings__&&(d=copy.update(d,b.__mappings__)),Array.isArray(b.__properties__)&&(e=copy.update(e,b.__properties__)),a.__mappings__=d,a.__properties__=e,a.extend=extend.bind(a),a}function beforeinstance(a,b,c){if(b.__processed__)return b;var d=c[0],e=d&&"object"==typeof d,f=a.__mappings__,g=a.__properties__;return e&&Array.isArray(d)&&(d={properties:d}),f&&"object"==typeof f&&(b.mappings=e?copy.update(d.mappings||{},f):copy.update(f),!e||delete d.mappings),g&&"object"==typeof g&&(e?Array.isArray(d.properties)?d.overwrites=g:delete d.properties:b.properties=copy.update(g)),copy(b,d)}function extend(a){function b(){this.__processing__||(this.__processing__=!0,beforeinstance(this.constructor,this,arguments),delete this.__processing__,this.__processed__=!0),c.apply(this,arguments)}var c=Object.prototype.hasOwnProperty.call(a,"constructor")?a.constructor:this,d=copy(Object.create(this.prototype),a);return d.constructor=b,b.prototype=d,b.__super__=this,afterdefine(b)}function is_num(a){return"number"==typeof a&&!isNaN(a)}function Property(a){copy(this,a||{}),this.init(),this.initType(this.type),this.initFormat(this.format)}var Schema,UNDEF,copy=require("useful-copy"),iter=require("useful-iter"),type=require("useful-type"),value=require("useful-value"),re_falsey=/^false|0$/;Schema=module.exports=extend.call(Object,{constructor:function(){this.initCoerceRoot(this.coerceRoot),this.initProperties(this.properties),this.initOverwrites(this.overwrites),delete this.overwrites},coerceRoot:null,mappings:null,properties:null,property:null,coerce:function(a,b){for(var c=this.prepare(a),d=-1,e=c.items.length;++d<e;)c.items[d]=this.coerceItem(c.items[d],b);return this.finalize(c)},coerceItem:function(a,b){var c,d=this.createRootItem();if(iter.invoke(this.properties,"process",copy.update(this.getItemRoot(a)),d),b===!0)for(c in a)c in d||!Object.prototype.hasOwnProperty.call(a,c)||(d[c]=a[c]);return this.finalizeItem(d)},finalize:function(a){return a},finalizeItem:function(a){return a},getItemRoot:function(a){var b=this.mappings.item;return b?value(a,b)||a:a},getRoot:function(a){if(!a)return[];var b=this.mappings.items,c=Array.isArray(a)?a:b?value(a,b)||a:a;return Array.isArray(c)?c.slice():[]},prepare:function(a){var b,c=!1,d=-1;return a&&"object"==typeof a?(b=this.getRoot(a),d=this.mappings.total in a?a[this.mappings.total]:b.length,c=this.mappings.success in a?a[this.mappings.success]:!!d):b=[],{items:b,success:c,total:d}},toJSON:function(a){var b,c=this.property,d={};for(b in c)Object.prototype.hasOwnProperty.call(c,b)&&(d[b]=c[b].toJSON(a[b]));return d},addProperty:function(a){a&&"object"==typeof a&&(a instanceof Property||(a=new Property(a)),this.properties.push(this.property[a.id]=a))},createRootItem:function(){return new this.coerceRoot},initCoerceRoot:function(a){switch(typeof a){case"function":break;case"string":switch(a.toLowerCase()){case"array":a=Array;break;default:a=Object}break;default:a=Object}this.coerceRoot=a},initProperties:function(a){if(!Array.isArray(a))throw new TypeError("Schema: `properties` must be an Array");this.properties=[],this.property=Object.create(null),a.forEach(this.addProperty,this)},initOverwrites:function(a){if(Array.isArray(a))for(var b,c=-1,d=a.length;++c<d;)b=a[c],b.id in this.property?copy.merge(this.property[b.id],b):this.addProperty(b)}}),Schema.Property=Property,Property.prototype={constructor:Property,cite:null,id:null,schema:null,store:null,strict:!0,type:"object",applyFormat:null,re_collection:/([^\[]+)\[\]$/,coerce:function(a,b,c){return this.applyFormat(this,a,this.format,b,c)},process:function(a,b){var c=this.value(a,b),d=this.coerce(c,a,b);return this.assign(d,b)},toJSON:function(a){return a},transform:function(a){return a},valid:function(a){return null!==a&&a!==UNDEF},value:function(a,b){var c=this.transform(value(a,this.cite),a,b);return c===this?UNDEF:c},assign:function(a,b){return(this.strict===!0||this.valid(a))&&value.assign(b,this.id,a),b},init:function(){!value.exists(this.cite)&&this.id&&(this.cite=this.id),!value.exists(this.id)&&this.cite&&(this.id=this.cite)},initFormat:function(a){var b=type.native(a).toUpperCase();this.applyFormat=Property.FORMAT_AS[b]||Property.FORMAT_AS.DEFAULT},initType:function(a){var b=Property.TYPE_DEFAULTS,c=Property.DATA_TYPE,d=Property.VALIDATION;if(a)switch(typeof a){case"string":a=a.toLowerCase(),a in c&&(this.type=c[a],a in b&&(copy.update(this,b[a]),"function"==typeof b[a].toJSON&&(this.toJSON=b[a].toJSON)),"function"==typeof d[a]&&(this.valid=d[a]));break;case"function":this.type=a}if("function"!=typeof this.type)throw new TypeError("Schema.Property","Invalid `type` specified.")}},Schema.__mappings__={id:"id",item:null,items:"items",success:"success",total:"total"},Schema.Date={clone:function(a){return a.clone()},coerce:function(a,b){return Date.coerce(a,b)},format:function(a,b){return a.format(b)}},Property.DATA_TYPE={array:function(a){return this.strict&&this.schema?this.schema.coerce(a).items||[]:(a=null===a||a===UNDEF?Array.isArray(this.default)?copy.merge([],this.default):[]:Array.isArray(a)||"object"==typeof a&&"length"in a?Array.prototype.slice.call(a):[a],a=Array.isArray(a)?a:value.exists(a)?Array.prototype.slice.call(a):[],is_num(this.max)&&a.length>this.max&&(a.length=this.max),a)},"boolean":function(a){return null===a||a===UNDEF?"boolean"==typeof this.default?this.default:!1:("boolean"!=typeof a&&(a=re_falsey.test(a)?!1:"boolean"==typeof this.default?this.default:!!a),a)},date:function(a,b){var c=is_num(a)?new Date(a):a,d=+this.max,e=+this.min;if("date"!=type.native(a))if(b||(b=this.format),null===a||a===UNDEF)c=0/0;else switch(typeof b){case"string":c=Schema.Date.coerce(a,b);break;case"function":c=b(a);break;default:c=new Date(a)}return c=is_num(+c)?c:"now"==this.default?new Date:new Date(+this.default),a=+c,e&&is_num(e)&&e>a&&(c=Schema.Date.clone(this.min)),d&&is_num(d)&&a>d&&(c=Schema.Date.clone(this.max)),c},number:function(a){a=Number(a)==a?Number(a):this.default;var b=this.max,c=this.min;return is_num(c)&&c>a&&(a=+c),is_num(b)&&a>b&&(a=+b),a},object:function(a){return this.strict&&this.schema?this.schema.coerceItem(a):a===UNDEF?this.default:a},string:function(a){return a=String(a)==a?String(a):this.default,is_num(this.max)&&a.length>this.max&&(a=a.substring(0,this.max)),a}},Object.keys(Property.DATA_TYPE).forEach(function(a){this[a].id=a},Property.DATA_TYPE),Property.FORMAT_AS={DEFAULT:function(a,b){return a.type(b)},FUNCTION:function(a,b,c,d,e){return a.type(c.call(a,b,d,e))},STRING:function(a,b,c){return a.type(b,c)}},Property.TYPE_DEFAULTS={array:{min:0,max:Math.pow(2,32)-1,toJSON:function(a){return JSON.stringify(a)}},"boolean":{"default":!1},date:{"default":"now",format:"U",toJSON:function(a){return a instanceof Date?Schema.Date.format(a,this.format):a}},object:{toJSON:function(a){return JSON.stringify(a)}},number:{"default":0/0,max:Number.POSITIVE_INFINITY,min:Number.NEGATIVE_INFINITY},string:{"default":""}},Property.VALIDATION={array:function(a){return"[object Array]"===Object.prototype.toString.call(a)&&a.length},"boolean":function(a){return"boolean"==typeof a},date:function(a){return"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(+a)},number:function(a){return"number"==typeof a&&!isNaN(a)},string:function(a){return"string"==typeof a}};